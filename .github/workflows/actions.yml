# about runners https://docs.github.com/en/actions/using-github-hosted-runners/using-github-hosted-runners/about-github-hosted-runners#standard-github-hosted-runners-for-public-repositories
name: CNPlus CI (Android) App Build

env:
  # The name of the main module repository
  main_project_module: app

  # The name of the Play Store
  app_name: "Calendar Notifications Plus"

  app_file_name_prefix: "calendar_notifications_plus"

  # Explicitly set CI flag to true for our Gradle task
  CI: true

  # Android Emulator Configuration
  ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL: 5
  ANDROID_API_LEVEL: 34
  ANDROID_TARGET: google_apis
  ANDROID_ARCH: x86_64
  ANDROID_PROFILE: 7.6in Foldable
  ANDROID_BUILD_TOOLS_VERSION: "34.0.0"
  
  # Define constant for each job to use
  GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.workers.max=4 -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"

on:
  push:
    tags:
      - '**'
  pull_request:
    branches:
      - "**" # https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#patterns-to-match-branches-and-tags

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64-v8a, x86_64]
      # Add fail-fast:false to allow both architectures to complete independently
      fail-fast: false
    env:
      ENTRY_FILE: "index.tsx"
      GRADLE_ABI: ${{ matrix.arch }}
    timeout-minutes: 30
    outputs:
      build_datetime: ${{ steps.set_date.outputs.build_datetime }}
      repository_name: ${{ steps.set_repo.outputs.repository_name }}
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 1 # Shallow clone for faster checkout
    
    # Set CPU count for Gradle
    - name: Set CPU count
      run: echo "GRADLE_MAX_WORKERS=4" >> $GITHUB_ENV
      
    - name: Use Node.js 22.x
      uses: actions/setup-node@v3
      with:
        node-version: 22.x
        cache: "yarn"

    - name: Set current date as env variable
      id: set_date
      run: |
        echo "build_datetime=$(date +'%Y-%m-%d %H_%M_%S')" >> $GITHUB_ENV
        echo "build_datetime=$(date +'%Y-%m-%d %H_%M_%S')" >> $GITHUB_OUTPUT

    # Set Repository Name As Env Variable
    - name: Set repository name as env variable
      id: set_repo
      run: |
        echo "repository_name=$(echo '${{ github.repository }}' | awk -F '/' '{print $2}')" >> $GITHUB_ENV
        echo "repository_name=$(echo '${{ github.repository }}' | awk -F '/' '{print $2}')" >> $GITHUB_OUTPUT

    - name: Expose yarn config as "$GITHUB_OUTPUT"
      id: yarn-config
      shell: bash
      run: |
        echo "CACHE_FOLDER=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT
  
    - name: Restore yarn cache
      uses: actions/cache@v3
      id: yarn-download-cache
      with:
        path: ${{ steps.yarn-config.outputs.CACHE_FOLDER }}
        key: yarn-download-cache-${{ hashFiles('yarn.lock') }}
        restore-keys: |
          yarn-download-cache-

    - name: Restore yarn install state
      id: yarn-install-state-cache
      uses: actions/cache@v3
      with:
        path: .yarn/ci-cache/
        key: ${{ runner.os }}-yarn-install-state-cache-${{ hashFiles('yarn.lock', '.yarnrc.yml') }}

    - run: yarn install --immutable --inline-builds
      env:
        YARN_ENABLE_GLOBAL_CACHE: 'false'
        YARN_NM_MODE: 'hardlinks-local'
        YARN_INSTALL_STATE_PATH: .yarn/ci-cache/install-state.gz
        HUSKY: '0'
    
    - name: Setup react-native-safe-area-context mock
      run: node scripts/setup_safe_area_mock.js

    - name: set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4.0.0
      with:
        cache-read-only: ${{ github.ref != 'refs/heads/main' }}
        gradle-home-cache-cleanup: true
        gradle-home-cache-includes: |
          caches
          notifications
          jdks
          wrapper

    - name: Grant execute permission for gradlew
      run: cd android && chmod +x gradlew

    # List all available Gradle tasks
    - name: List Gradle Tasks also warms up gradle cache
      run: |
        cd android && \
        ./gradlew tasks --all

    # Cache build outputs for test job
    - name: Restore Build Outputs Cache
      uses: actions/cache@v4
      id: build-outputs-cache
      with:
        path: |
          android/app/build/intermediates
          android/app/build/tmp
          android/app/build/generated
          android/app/build/outputs
          android/app/build/intermediates/instrumented_classes
          android/app/build/intermediates/test_apk
          android/app/build/intermediates/test_apk_androidTest
        key: ${{ runner.os }}-build-outputs-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-outputs-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    # Cache React Native specific files
    - name: Restore React Native Cache
      uses: actions/cache@v4
      id: react-native-cache
      with:
        path: |
          node_modules/.cache/react-native
          node_modules/.cache/metro
          node_modules/.cache/@react-native-community/cli
        key: ${{ runner.os }}-react-native-${{ hashFiles('package.json', 'yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-react-native-

    # Cache Gradle files
    - name: Restore Gradle Cache
      uses: actions/cache@v4
      id: gradle-cache
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
          android/build-cache
        key: ${{ runner.os }}-gradle-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-${{ matrix.arch }}-
          ${{ runner.os }}-gradle-

    # Cache NDK and CMake builds
    - name: Restore NDK and CMake Cache
      uses: actions/cache@v4
      id: ndk-cache
      with:
        path: |
          .cxx
          ~/.android/ndk
          ~/.android/cmake
          android/app/.cxx
          android/app/build/intermediates/cmake
          android/app/build/intermediates/merged_native_libs
          android/app/build/intermediates/stripped_native_libs
          android/app/build/intermediates/transforms
        key: ${{ runner.os }}-ndk-cmake-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/CMakeLists.txt', '**/*.cmake', '**/*.cpp', '**/*.h', '**/*.hpp') }}
        restore-keys: |
          ${{ runner.os }}-ndk-cmake-${{ matrix.arch }}-

    # Cache JS Bundle and Assets
    - name: Restore JS Bundle and Assets Cache
      uses: actions/cache@v4
      id: js-bundle-cache
      with:
        path: |
          android/app/src/main/assets/index.android.bundle
          android/app/src/main/res/drawable-*
          android/app/src/main/res/raw-*
        key: ${{ runner.os }}-js-bundle-${{ hashFiles('package.json', 'yarn.lock') }}-${{ hashFiles('src/**/*.{js,jsx,ts,tsx}', 'lib/**/*.{js,jsx,ts,tsx}', 'modules/**/*.{js,jsx,ts,tsx}', 'App.{js,jsx,ts,tsx}', 'index.{js,jsx,ts,tsx}') }}
        restore-keys: |
          ${{ runner.os }}-js-bundle-${{ hashFiles('package.json', 'yarn.lock') }}-
          ${{ runner.os }}-js-bundle-

    # Generate JS bundle using our script
    - name: Generate JS Bundle
      if: steps.js-bundle-cache.outputs.cache-hit != 'true'
      run: |
        yarn bundle:android

    - name: Update JS Bundle and Assets Cache
      if: steps.js-bundle-cache.outputs.cache-hit != 'true'
      uses: actions/cache@v4
      with:
        path: |
          android/app/src/main/assets/index.android.bundle
          android/app/src/main/res/drawable-*
          android/app/src/main/res/raw-*
        key: ${{ runner.os }}-js-bundle-${{ hashFiles('package.json', 'yarn.lock') }}-${{ hashFiles('src/**/*.{js,jsx,ts,tsx}', 'lib/**/*.{js,jsx,ts,tsx}', 'modules/**/*.{js,jsx,ts,tsx}', 'App.{js,jsx,ts,tsx}', 'index.{js,jsx,ts,tsx}') }}

    - name: Restore External Native aka CMake Build Cache
      uses: actions/cache@v4
      id: cmake-cache
      with:
        path: |
          android/app/.cxx
          android/app/build/intermediates/cmake
          android/app/build/intermediates/merged_native_libs
          android/app/build/intermediates/stripped_native_libs
          android/app/build/intermediates/transforms
          android/app/build/intermediates/prefab
          android/app/build/intermediates/prefab_package
          android/app/build/intermediates/prefab_metadata
        key: ${{ runner.os }}-cmake-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/CMakeLists.txt', '**/*.cmake', '**/*.cpp', '**/*.h', '**/*.hpp', '**/*.so') }}
        restore-keys: |
          ${{ runner.os }}-cmake-${{ matrix.arch }}-

    # Build CMake components first
    - name: Build CMake components first
      if: steps.cmake-cache.outputs.cache-hit != 'true'
      run: |
        cd android && \
        ./gradlew externalNativeBuildDebug \
                  externalNativeBuildRelease \
        --parallel --max-workers=4 --build-cache

    - name: Update CMake Build Outputs Cache
      if: steps.cmake-cache.outputs.cache-hit != 'true'
      uses: actions/cache@v4
      with:
        path: |
          android/app/.cxx
          android/app/build/intermediates/cmake
          android/app/build/intermediates/merged_native_libs
          android/app/build/intermediates/stripped_native_libs
          android/app/build/intermediates/transforms
          android/app/build/intermediates/prefab
          android/app/build/intermediates/prefab_package
          android/app/build/intermediates/prefab_metadata
        key: ${{ runner.os }}-cmake-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/CMakeLists.txt', '**/*.cmake', '**/*.cpp', '**/*.h', '**/*.hpp', '**/*.so') }}

    - name: Build Android APKs (Debug and Release) with Gradle
      if: steps.build-outputs-cache.outputs.cache-hit != 'true'
      run: |
        cd android && \
        ./gradlew :${{ env.main_project_module }}:assemble${{ matrix.arch == 'arm64-v8a' && 'Arm64V8a' || 'X8664' }}Debug \
                  :${{ env.main_project_module }}:assemble${{ matrix.arch == 'arm64-v8a' && 'Arm64V8a' || 'X8664' }}Release \
                  :${{ env.main_project_module }}:bundle${{ matrix.arch == 'arm64-v8a' && 'Arm64V8a' || 'X8664' }}Release \
                  :${{ env.main_project_module }}:assemble${{ matrix.arch == 'arm64-v8a' && 'Arm64V8a' || 'X8664' }}DebugAndroidTest \
        --parallel --max-workers=4 --build-cache \
        -Pandroid.prefabPublishing=true \
        -Pandroid.prefabPackageType=STATIC

    - name: Update Build Outputs Cache
      if: steps.build-outputs-cache.outputs.cache-hit != 'true'
      uses: actions/cache@v4
      with:
        path: |
          android/app/build/intermediates
          android/app/build/tmp
          android/app/build/generated
          android/app/build/outputs
          android/app/build/intermediates/instrumented_classes
          android/app/build/intermediates/test_apk
          android/app/build/intermediates/test_apk_androidTest
        key: ${{ runner.os }}-build-outputs-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'android/app/**') }}

    # Save the build artifacts to be used in other jobs
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-artifacts-${{ matrix.arch }}
        path: android/${{ env.main_project_module }}/build/outputs/apk/
        retention-days: 1
        if-no-files-found: error

    - name: Upload Bundle artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-bundle-artifacts-${{ matrix.arch }}
        path: android/${{ env.main_project_module }}/build/outputs/bundle/
        retention-days: 1
        if-no-files-found: error

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: android-test-coverage-report
        path: |
          android/app/build/reports/jacoco/jacocoAndroidTestReport/
          android/app/build/outputs/code_coverage/debugAndroidTest/connected/
        retention-days: 90

  sign:
    name: Sign Android APKs and Bundles (${{ matrix.arch }})
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64-v8a, x86_64]
    env:
      ENTRY_FILE: "index.tsx"
      GRADLE_ABI: ${{ matrix.arch }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      # Import build variables from build job
      - name: Set build variables
        run: |
          echo "build_datetime=${{ needs.build.outputs.build_datetime }}" >> $GITHUB_ENV
          echo "repository_name=${{ needs.build.outputs.repository_name }}" >> $GITHUB_ENV
          
      # Download build artifacts for current architecture
      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apk-artifacts-${{ matrix.arch }}
          path: artifacts/apk/

      - name: Download Bundle artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-bundle-artifacts-${{ matrix.arch }}
          path: artifacts/bundle/
      
      # Prepare directory structure for signing
      - name: Prepare directories for signing
        run: |
          mkdir -p signing/apk/debug
          mkdir -p signing/apk/release
          mkdir -p signing/bundle/release
          
          # Organize APKs by type
          find artifacts/apk/ -path "*/debug/*" -name "*.apk" -exec cp {} signing/apk/debug/ \;
          find artifacts/apk/ -path "*/release/*" -name "*.apk" -exec cp {} signing/apk/release/ \;
          find artifacts/bundle/ -name "*.aab" -exec cp {} signing/bundle/release/ \;
          
          # Verify contents
          echo "Files to sign:"
          find signing -type f | sort

      # Sign the APKs and AAB
      - uses: r0adkll/sign-android-release@v1
        name: Sign debug app APKs
        id: sign_debug_app
        with:
          releaseDirectory: signing/apk/debug/
          signingKeyBase64: ${{ secrets.DEBUG_SIGNING_KEYSTORE }}
          alias: ${{ secrets.DEBUG_KEYSTORE_ALIAS }}
          keyStorePassword: ${{ secrets.DEBUG_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.DEBUG_KEYSTORE_ALIAS_PASS }}
        env:
          BUILD_TOOLS_VERSION: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - uses: r0adkll/sign-android-release@v1
        name: Sign RELEASE app APKs
        id: sign_release_app
        with:
          releaseDirectory: signing/apk/release/
          signingKeyBase64: ${{ secrets.RELEASE_SIGNING_KEYSTORE }}
          alias: ${{ secrets.RELEASE_KEYSTORE_ALIAS }}
          keyStorePassword: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.RELEASE_KEYSTORE_ALIAS_PASS }}
        env:
          BUILD_TOOLS_VERSION: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}
      
      - uses: r0adkll/sign-android-release@v1
        name: Sign RELEASE app AABs
        id: sign_release_aab
        with:
          releaseDirectory: signing/bundle/release/
          signingKeyBase64: ${{ secrets.RELEASE_SIGNING_KEYSTORE }}
          alias: ${{ secrets.RELEASE_KEYSTORE_ALIAS }}
          keyStorePassword: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.RELEASE_KEYSTORE_ALIAS_PASS }}
        env:
          BUILD_TOOLS_VERSION: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      # Rename APKs
      - name: Rename and organize signed artifacts
        run: |
          mkdir -p renamed_apks
          
          sanitize_branch_name() {
            echo "$1" | sed 's/[^a-zA-Z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-20
          }

          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # For tags
            VERSION=${GITHUB_REF#refs/tags/v}
            SUFFIX="-${VERSION}"
          elif [[ $GITHUB_REF == refs/pull/* ]]; then
            # For pull requests
            PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
            BRANCH_NAME=$(sanitize_branch_name "$GITHUB_HEAD_REF")
            SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
            SUFFIX="-pr-${PR_NUMBER}-${BRANCH_NAME}-${SHORT_SHA}"
          else
            # For pushes to branches other than main
            BRANCH_NAME=$(sanitize_branch_name "${GITHUB_REF#refs/heads/}")
            SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
            SUFFIX="-${BRANCH_NAME}-${SHORT_SHA}"
          fi
          
          # Find and rename signed debug APKs
          find signing/apk/debug/ -name "*-signed.apk" | while read apk; do
            cp "$apk" renamed_apks/${{env.app_file_name_prefix}}${SUFFIX}-${{ matrix.arch }}-debug.apk
          done
          
          # Find and rename signed release APKs
          find signing/apk/release/ -name "*-signed.apk" | while read apk; do
            cp "$apk" renamed_apks/${{env.app_file_name_prefix}}${SUFFIX}-${{ matrix.arch }}-release.apk
          done
          
          # Find and rename signed AABs
          find signing/bundle/release/ -name "*-signed.aab" | while read aab; do
            cp "$aab" renamed_apks/${{env.app_file_name_prefix}}${SUFFIX}-${{ matrix.arch }}.aab
          done
          
          # List all renamed files
          echo "Renamed files:"
          ls -la renamed_apks/

      # Upload signed artifacts
      - name: Upload SIGNED APK Debug
        uses: actions/upload-artifact@v4
        with:
          name: "signed-${{ env.build_datetime }}-${{ env.app_name }}-APK-debug-${{ matrix.arch }}"
          path: renamed_apks/${{env.app_file_name_prefix}}-*-debug.apk

      - name: Upload SIGNED APK RELEASE
        uses: actions/upload-artifact@v4
        with:
          name: "signed-${{ env.build_datetime }}-${{ env.app_name }}-APK-release-${{ matrix.arch }}"
          path: renamed_apks/${{env.app_file_name_prefix}}-*-release.apk

      - name: Upload SIGNED AAB (App Bundle) Release
        uses: actions/upload-artifact@v4
        with:
          name: "signed-${{ env.build_datetime }}-${{ env.app_name }}-AAB-release-${{ matrix.arch }}"
          path: renamed_apks/${{env.app_file_name_prefix}}-*.aab

  test:
    name: Test Android App
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64] # Only test on x86_64 to save time and resources
      fail-fast: false
    env:
      ENTRY_FILE: "index.tsx"
      GRADLE_ABI: ${{ matrix.arch }}
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 1
    
    # Set CPU count for Gradle
    - name: Set CPU count
      run: echo "GRADLE_MAX_WORKERS=4" >> $GITHUB_ENV
      
    # Restore cached Gradle files
    - name: Restore Gradle Cache
      uses: actions/cache@v4
      id: gradle-cache
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
          android/build-cache
        key: ${{ runner.os }}-gradle-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-${{ matrix.arch }}-
          ${{ runner.os }}-gradle-

    # Download the build artifacts - only for the architecture being tested
    - name: Download APK artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-apk-artifacts-${{ matrix.arch }}
        path: android/${{ env.main_project_module }}/build/outputs/apk/

    - name: Use Node.js 22.x
      uses: actions/setup-node@v3
      with:
        node-version: 22.x
        cache: "yarn"

    - name: Install dependencies
      run: yarn install --immutable --inline-builds
      env:
        YARN_ENABLE_GLOBAL_CACHE: 'false'
        YARN_NM_MODE: 'hardlinks-local'
        HUSKY: '0'

    - name: Setup react-native-safe-area-context mock
      run: node scripts/setup_safe_area_mock.js

    - name: set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4.0.0
      with:
        cache-read-only: ${{ github.ref != 'refs/heads/main' && (github.event_name != 'pull_request' || github.event.pull_request.number != 62) }}
        gradle-home-cache-cleanup: true
        gradle-home-cache-includes: |
          caches
          notifications
          jdks
          wrapper

    - name: Grant execute permission for gradlew
      run: cd android && chmod +x gradlew

    # Download build outputs from build job
    - name: Restore Build Outputs Cache
      uses: actions/cache@v4
      id: build-outputs-cache
      with:
        path: |
          android/app/build/intermediates
          android/app/build/tmp
          android/app/build/generated
          android/app/build/outputs
          android/app/build/intermediates/instrumented_classes
          android/app/build/intermediates/test_apk
          android/app/build/intermediates/test_apk_androidTest
        key: ${{ runner.os }}-build-outputs-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-outputs-${{ matrix.arch }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    - name: Enable KVM for Emulator
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Restore Android SDK and AVD Cache
      uses: actions/cache@v4
      id: android-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
          ~/.android/sdk/*
          ~/.android/repositories.cfg
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-android-

    - name: Setup Android SDK
      if: steps.android-cache.outputs.cache-hit != 'true'
      uses: android-actions/setup-android@v3
      with:
        packages: 'tools platform-tools system-images;android-${{ env.ANDROID_API_LEVEL }};${{ env.ANDROID_TARGET }};${{ env.ANDROID_ARCH }}'
        accept-android-sdk-licenses: true
        log-accepted-android-sdk-licenses: false

    - name: create AVD and generate snapshot for caching
      if: steps.android-cache.outputs.cache-hit != 'true'
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        target: ${{ env.ANDROID_TARGET }}
        arch: ${{ env.ANDROID_ARCH }}
        profile: ${{ env.ANDROID_PROFILE }}
        force-avd-creation: false
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -no-snapshot
        disable-animations: true
        script: |
          adb wait-for-device
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
          echo "Generated AVD snapshot for caching."

    - name: Make wait script executable
      run: chmod +x scripts/wait_for_emulator.sh

    - name: Make test script executable
      run: chmod +x scripts/run_android_tests.sh

    - name: Run Android Tests with Coverage
      id: run_tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        target: ${{ env.ANDROID_TARGET }}
        arch: ${{ matrix.arch }}
        profile: ${{ env.ANDROID_PROFILE }}
        force-avd-creation: false
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -no-snapshot -memory 2048
        disable-animations: true
        script: |
          ./scripts/wait_for_emulator.sh && ./scripts/run_android_tests.sh ${{ matrix.arch }} ${{ env.main_project_module }} ${{ env.ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL }}

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: android-test-coverage-report
        path: |
          android/app/build/reports/jacoco/jacocoAndroidTestReport/
          android/app/build/outputs/code_coverage/debugAndroidTest/connected/
        retention-days: 90

    - name: Upload Emulator Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: emulator-log
        path: emulator.log
        retention-days: 90

  comment-pr:
    name: Comment on PR with build links
    if: github.event_name == 'pull_request'
    needs: sign
    runs-on: ubuntu-latest
    steps:
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const workflowUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Build artifacts for this PR are available:

              - [Debug APKs (arm64-v8a, x86_64)](${workflowUrl}#artifacts)
              - [Release APKs (arm64-v8a, x86_64)](${workflowUrl}#artifacts)
              - [AAB](${workflowUrl}#artifacts)

              You can download these artifacts from the "Artifacts" section of the workflow run.`
            });

  create-release:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: sign
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: signed-*
          path: artifacts
      
      - name: Generate Changelog
        run: |
          echo "# Release ${GITHUB_REF#refs/tags/}" > ${{ github.workspace }}-CHANGELOG.txt
          echo "" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "## What's Changed" >> ${{ github.workspace }}-CHANGELOG.txt
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"* %s" >> ${{ github.workspace }}-CHANGELOG.txt
      
      - name: Organize release files
        run: |
          mkdir -p release_files
          find artifacts/ -name "*.apk" -o -name "*.aab" | xargs -I{} cp {} release_files/
      
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          files: release_files/*