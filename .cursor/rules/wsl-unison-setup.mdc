---
alwaysApply: false
---
# Development Environment Setup - WSL/Unison Sync

This project uses a dual-filesystem setup for development:

## File Locations

- **Linux/WSL location** (primary development location):
  `/home/william/not_connected_to_windows/CalendarNotification`

- **Windows location** (for Android builds - use short path!):
  - **Short path**: `C:\dev\CN` or `/mnt/c/dev/CN` — BUILD FROM HERE
  - **Junction for backwards compat**: `C:\Users\william\unison-with-dropbox-symlinked-to-linux\CalendarNotification` → `C:\dev\CN`

## Sync Strategy

- **Unison** syncs files between Linux and Windows using profile `non_windows_cnplus.prf`
- Syncs directly: `/mnt/c/dev/CN` ↔ `/home/william/not_connected_to_windows/CalendarNotification`
- **`node_modules` is NOT synced** — install separately on each side
- Run with: `unison non_windows_cnplus`

### ⚠️ CRITICAL: Never sync through the junction!

Unison must point to the **real short path** (`/mnt/c/dev/CN`), NOT the junction path. If you sync through the junction, Unison will replace your Linux directory with a symlink to `/mnt/c/...`, completely defeating the fast-filesystem setup and potentially destroying data.

## Implications

- When referencing paths, prefer the Linux location (`/home/william/not_connected_to_windows/CalendarNotification`)
- If `node_modules` appears missing or incomplete, run `npm install` on that side
- Git operations and file system operations are faster on the Linux side
- **Windows Android builds**: Use `C:\dev\CN\android` (short path) to avoid 260-char path limit
- File system permission issues may occur when accessing Windows files from Linux and vice versa (hence keeping them separate)

## Windows Long Path Issue (New Architecture)

React Native's New Architecture codegen creates very long file paths that can exceed Windows' 260-character limit. The long project path (`unison-with-dropbox-symlinked-to-linux`) makes this worse.

### What Doesn't Work

- **`subst` drive letter**: Node/Gradle can't properly resolve modules through virtual drives
- **Junction pointing TO long path**: Build tools "see through" junctions and resolve to the real (long) path

### Solution: Short Path + Junction (December 2024)

Real files live at a short Windows path. Junction at old path provides backwards compatibility:

```
Real files:     C:\dev\CN  ←── BUILD FROM HERE + UNISON SYNCS HERE
                   ↑
         ┌─────────┴─────────┐
         │                   │
Junction from old path   Direct access
(backwards compat only - DO NOT sync through this!)
```

**Setup (one-time)**:
```powershell
# Move files to short path
Move-Item "C:\Users\william\unison-with-dropbox-symlinked-to-linux\CalendarNotification" "C:\dev\CN"

# Create junction at old location → short path
cmd /c mklink /J "C:\Users\william\unison-with-dropbox-symlinked-to-linux\CalendarNotification" "C:\dev\CN"
```

**Build from short path**:
```powershell
cd C:\dev\CN\android
.\gradlew assembleDebug
```

### Separate Issue: React Native 0.81.5 C++ Bug

After fixing paths, you may hit `std::format` compilation errors — this is an RN/NDK bug, not a path issue.
**Quick fix**: Set `newArchEnabled=false` in `android/gradle.properties`

See full docs: `linuxshared_folder_usage_docs/windows_short_path_for_android_builds.md`

## NativeWind ESM Issue (Metro on Windows)

NativeWind v4 has a known issue where Metro cannot load the config on Windows due to ESM path handling. This causes errors like:
```
Error [ERR_UNSUPPORTED_ESM_URL_SCHEME]: Only URLs with a scheme in: file, data, and node are supported by the default ESM loader. On Windows, absolute paths must be valid file:// URLs. Received protocol 'c:'
```

**Workaround**: Pre-bundle on WSL, then build on Windows.

1. **Pre-bundle on WSL** (when JS/CSS changes):
   ```bash
   cd /home/william/not_connected_to_windows/CalendarNotification
   yarn bundle:android --dev=true
   ```

2. **Build on Windows** (uses pre-built bundle):
   ```powershell
   cd C:\dev\CN\android
   .\gradlew assembleDebug
   ```

The `scripts/bundle_or_skip.js` wrapper automatically detects and copies the pre-built bundle, skipping Metro on Windows. This is configured via `cliFile` in `android/app/build.gradle`.

See: https://github.com/nativewind/nativewind/issues/1667

## Running Android Instrumentation Tests

Android instrumentation tests (`connectedAndroidTest`) must be run from **Windows**, not WSL. The test runner communicates with the emulator over ports that don't work properly through WSL.

### From WSL Terminal (via PowerShell)

```bash
# Wait for Unison sync after file changes (~15 seconds)
sleep 15

# Run all tests for a specific class
powershell.exe -Command 'cd C:\dev\CN\android; $env:JAVA_HOME = "C:\Program Files\Android\Android_Studio\jbr"; .\gradlew.bat :app:connectedX8664DebugAndroidTest "-Pandroid.testInstrumentationRunnerArguments.class=com.github.quarck.calnotify.monitorstorage.MonitorStorageMigrationTest"'

# Run all instrumentation tests
powershell.exe -Command 'cd C:\dev\CN\android; $env:JAVA_HOME = "C:\Program Files\Android\Android_Studio\jbr"; .\gradlew.bat :app:connectedX8664DebugAndroidTest'
```

### Important Notes

1. **Wait for sync**: Unison syncs every 10 seconds (no inotify on Windows mounts). Wait 15s after file changes before running tests.

2. **JAVA_HOME**: Must be set in PowerShell. Android Studio's bundled JBR is at `C:\Program Files\Android\Android_Studio\jbr`

3. **Test filtering**: Use `-Pandroid.testInstrumentationRunnerArguments.class=...`, NOT `--tests` (which doesn't work for `connectedAndroidTest`)

4. **Signature conflicts**: If you get `INSTALL_FAILED_UPDATE_INCOMPATIBLE`, uninstall the app first:
   ```bash
   adb uninstall com.github.quarck.calnotify
   ```

5. **Building APKs**: Can be done from either side, but running connected tests requires Windows.
